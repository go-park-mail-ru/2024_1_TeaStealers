# Защита от SQL Injections

В нашем проекте мы используем библиотеку jackc/pgx/v4, которая поддерживает запросы с использованием плейсхолдеров `$1`, `$2` и т.д.

Пример кода:
```
insert := `INSERT INTO 
advert (user_id, type_placement, title, description, phone, is_agent, priority)
VALUES ($1, $2, $3, $4, $5, $6, $7) RETURNING id`
```

# Пулл соединений и параметры соедений

Мы реализовали connection pool на строне приложения с помощью библиотеки jackc/pgx/v4/pgxpool

Код функции, создающий экземпляр `*pgxpool.Config` находится в "2024_1_TeaStealers/internal/pkg/config"

> Вопрос в том, как правильно сбалансировать количество содениений в connection pool и значение max_connections в postgresql.conf

Значение max_connections в postgresql.conf должно быть чуть больше, чем максимальное количество содениений в connection pool. 
Так всегда будет несколько доступных соединений для прямого подключения для обслуживания и мониторинга системы.

> Также необходимо правильно настроить параметр listen_addresses. Подумайте, настройте и аргументируйте ментору, какие адреса в вашем случае здесь должны быть указаны
```
listen_addresses = 'localhost' - так как все микросервисы на одной машине.
```

# Настройка параметров сервера и клиента

## Таймауты

Мы поставили таймаунт в 15 секунд, потому что исходя из бизнес-логики не имеет смысла так долго ждать выполнения запроса.

```
statement_timeout = 15s 
lock_timeout = 15s
```
> Например, подумайте о граничных случаях - например, есть ли смысл ставить ограничение, в 1 минуту?

Смысла ставить ограничение в 1 минуту нет, потому что, опять же нету смысла так долго ждать выполнение запроса.

> Будет ли у такого ограничения какая-то польза с точки зрения UX?

Нет, не будет

> А с точки зрения защиты вашей системы от DOS атак?

В случае DOS-атаки, злоумышленники будут получать timeout и сервер не будет нагружен слишком большим запросом долго.



## Логгирование и протоколирование медленных запросов

Эти параметры из `postgresql.conf` мы отредактировали для логирования.

```
log_line_prefix = '%t [%p]: '
logging_collector = on 
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_min_duration_statement = 7
log_error_verbosity = verbose
```

> А в какое именно (время, после которого запрос считается медленным) - вам необходимо придумать исходя из бизнес требований вашего приложения.

Мы поставили это значение равным 5ms, потому что у нас в принципе нет запросов, которые бы выполнялись дольше 6ms